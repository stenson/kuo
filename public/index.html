<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="Content-Type" content="text/html;charset=utf-8"/>
    <title>Kuo (How Worldly)</title>
    <script src="/js/lib/jquery.min.js"></script>
    <script src="/js/lib/d3.v3.js"></script>
    <script src="/js/lib/queue.min.js"></script>
    <script src="/js/lib/topojson.min.js"></script>
    <script src="/js/lib/underscore-min.js"></script>
    <style type="text/css">
      * { margin: 0; padding: 0; } 

      html, body, #container {
        height: 100%;
      }

      body {
        font-family: "Helvetica Neue", Arial, Helvetica, sans-serif;
        background-color: whitesmoke;
      }
      
      #container {
        position: relative;
      }
      
      #centered {
        position: absolute;
        top: 50%;
        left: 50%;
        height: 0px;
        width: 0px;
        overflow: visible;
      }
      
      #map-container {
        position: absolute;
        height: 500px;
        width: 760px;
        top: -254px;
        left: -380px;
      }
      
      #map {
        position: relative;
        height: 400px;
        width: 100%;
        background: #eef;
        border: 8px solid white;
      }
      
      path {
        fill: mediumaquamarine;
      }
      
      @-webkit-keyframes fade-out {
        0% { opacity:1.0; fill: yellow; stroke: gold; stroke-width: 12px; }
        100% { opacity:0.4; fill: none; stroke: salmon; stroke-width: 1px; }
      }
      
      circle {
        -webkit-animation: fade-out 1s;
        -webkit-animation-fill-mode: forwards;
      }
      
      #slider {
        background: lightyellow;
        width: 100%;
        height: 44px;
        margin-top: 10px;
        border: 8px solid white;
        position: relative;
      }
      
      #slidee {
        width: 44px;
        height: 44px;
        position: absolute;
        top: 0px;
        left: 0px;
        background: gold;
        cursor: pointer;
      }
      
      #slidee:hover { background: orange; }
      #slidee:active { background: darkorange; }
      
    </style>
  </head>
  <body>
    <div id="container">
      <div id="centered">
        <div id="map-container">
          <div id="map"></div>
          <div id="slider">
            <div id="slidee"></div>
          </div>
        </div>
      </div>
    </div>
    <script type="text/javascript">
    
      var $map = $("#map");
      var width = $map.width();
      var height = $map.height();
      
      var slider = (function() {
        var down = false;
        
        $("html, body")
          .on("mouseup", function() {
            down = false;
          })
          .on("mousemove", function() {
            if (down) {
              console.log("moving");
            }
          });
        
        $("#slidee")
          .on("mousedown", function() { down = true; })
          
        return {
          move: function() {
            
          }
        };
      })();
      
      var countries;
      var countryNameLookup = {};
      var artists = [];

      var projection = d3.geo.mercator().scale(120).translate([width / 2, height / 2 + 50])
      var path = d3.geo.path().projection(projection);
      
      var λ = d3.scale.linear().domain([0, width]).range([-180, 180]);
      var φ = d3.scale.linear().domain([0, height]).range([90, -90]);
      
      var svg = d3.select("#map").append("svg:svg").attr("width", width).attr("height", height);
      
      var lookupCountry = function(name) {
        var id = countryNameLookup[name];
        return id ? countries[id] : null;
      };
      
      queue()
      .defer(d3.json, "/data/geographic/world-110m.json")
      .defer(d3.tsv, "/data/geographic/world-country-names.tsv")
      .defer(d3.json, "/data/scraped/artists-2.json")
      .await(function(err, world, names, tracks) {
        svg.append("path")
          .datum(topojson.feature(world, world.objects.land))
          .attr("class", "land")
          .attr("d", path);
        
        countries = topojson.feature(world, world.objects.countries).features;
        countries = countries.filter(function(d) {
          return names.some(function(n) {
            if (d.id == n.id) return d.name = n.name;
          });
        });
        
        
        //borders = topojson.mesh(world, world.objects.countries, function(a, b) { return a !== b; });
        _.each(countries, function(country, i) { countryNameLookup[country.name] = i; });
        
        artists = _.compact(_.map(tracks, function(entry) {
          return entry.geocoded ? {
            artistName: entry.common.name,
            trackName: entry.rdio.name,
            coordinates: projection([entry.geocoded.lng, entry.geocoded.lat])
          } : null;
        }));
        
        var addArtist = function(artist) {
          svg.append("circle")
            .datum(artist)
            .attr("class", "artist")
            .attr("cx", function(d) { return d.coordinates[0]; })
            .attr("cy", function(d) { return d.coordinates[1]; })
            .attr("r", 10);
        };
        
        var runAnimation = function() {
          var timeout = 100;
          _.each(_.first(artists, 1000), function(artist) {
            setTimeout(_.bind(addArtist, null, artist), timeout += 100);
          });
        };
        
        runAnimation();
      });
      
      // var svgMousedown = false;
      // 
      // svg.on("mousedown", function() {
      //   svgMousedown = true;
      // });
      // 
      // svg.on("mousemove", function() {
      //   if (svgMousedown) {
      //     var p = d3.mouse(this);
      //     projection.rotate([λ(p[0]), φ(p[1])]);
      //     svg.selectAll("path").attr("d", path);
      //   }
      // });
      // 
      // svg.on("mouseup", function() {
      //   svgMousedown = false;
      // });
    
    </script>
  </body>
</html>
